rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // — Usuarios: solo auth pueden leer, y solo admin pueden escribir —
    match /users/{userId} {
      allow read:   if request.auth != null;
      allow create: if request.auth != null
                   && (request.auth.uid == request.resource.data.uid
                       || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow update, delete: if request.auth != null
                   && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // — Objetos: LECTURA PÚBLICA —  
    match /objects/{objectId} {
      // Cualquiera (incluso no auth) puede leer
      allow read: if true;
      // Solo auth puede crear
      allow create: if request.auth != null;
      // Solo admin puede actualizar o eliminar
      allow update, delete: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // — Bloquea todo lo demás —
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
