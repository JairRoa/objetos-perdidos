<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#2e9d57" />
  <link rel="icon" href="/img/favicon.png" type="image/x-icon" />
  <title>Gestión de Usuarios y Objetos Perdidos</title>

  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --verde-principal: #2e9d57;
      --verde-claro:    #7dd081;
      --amarillo-abeja: #f9d94e;
      --rojo:           #d9534f;
      --negro:          #1a1a1a;
      --blanco:         #fefefe;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    html, body { width:100%; overflow-x:hidden; }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: var(--negro);
      display:flex; flex-direction:column; min-height:100vh;
    }

    header {
      background: var(--verde-principal);
      color: var(--blanco);
      padding: 1rem; display:flex; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .logo { font-size:1.5rem; font-weight:bold; flex:1 1 auto; }
    .header-nav {
      flex:1 1 auto;
      display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center;
    }
    .header-nav a,
    .header-nav button.logout {
      flex:1 1 auto;
      text-align:center;
      padding:.5rem 1rem;
      border-radius:5px;
      font-weight:bold;
      text-decoration:none;
      transition:background .2s,color .2s;
    }
    .header-nav a { background: var(--verde-claro); color: var(--blanco); border:none; }
    .header-nav a:hover { background: var(--amarillo-abeja); color: var(--negro); }
    .header-nav button.logout { background: var(--rojo); color: var(--blanco); border:none; cursor:pointer; }
    .header-nav button.logout:hover { background:#c9302c; }

    .tabs {
      display:flex; flex-wrap:wrap;
      gap:.5rem; margin:1rem 0; width:100%;
      justify-content:center;
    }
    .tabs button {
      flex:1 1 45%;
      padding:.75rem;
      background: var(--amarillo-abeja);
      color: var(--blanco);
      border:none;
      border-radius:5px;
      font-weight:bold;
      text-align:center;
      transition:background .2s;
      cursor:pointer;
    }
    .tabs button.active { background: var(--verde-claro); }
    .tabs button:hover { background:#f0c94a; }

    main { flex:1; width:100%; max-width:960px; margin:0 auto; padding:0 1rem; }
    section { display:none; }
    section.active { display:block; }

    .entity-form {
      display:grid; grid-template-columns:1fr 1fr; gap:1rem;
      background:var(--blanco); padding:1rem; border-radius:8px; margin-bottom:1rem; width:100%;
    }
    .entity-form label { font-weight:bold; }
    .entity-form input, .entity-form select, .entity-form textarea {
      width:100%; padding:.5rem; border:1px solid #ccc; border-radius:4px;
    }
    .entity-form button {
      grid-column:span 2; padding:.75rem; background: var(--amarillo-abeja);
      color: var(--blanco); border:none; border-radius:5px; font-weight:bold; cursor:pointer; transition:background .2s;
    }
    .entity-form button[disabled] { opacity:.6; cursor:progress; }
    .entity-form button:hover { background: var(--verde-claro); }

    .admin-tools { display:flex; gap:.75rem; margin:.5rem 0 1rem; }
    .admin-tools button {
      padding:.5rem .75rem; border:none; border-radius:6px; font-weight:600; cursor:pointer;
      background:#e8f5e9; color:#1b5e20; border:1px solid #c8e6c9;
    }
    .admin-tools button[disabled]{ opacity:.6; cursor:progress; }

    .filters { display:flex; gap:.5rem; margin:.5rem 0 1rem; flex-wrap:wrap; }
    .filters input[type="search"]{ flex:2; min-width:220px; padding:.5rem; border:1px solid #ccc; border-radius:6px; }
    .filters select{ flex:1; min-width:180px; padding:.5rem; border:1px solid #ccc; border-radius:6px; }

    .code-search { display:flex; gap:.5rem; margin:.25rem 0 1rem; flex-wrap:wrap; }
    .code-search input[type="text"]{ flex:1; min-width:240px; padding:.5rem; border:1px solid #ccc; border-radius:6px; }
    .code-search button{ padding:.5rem .9rem; border:none; border-radius:6px; font-weight:600; cursor:pointer; background:var(--verde-principal); color:#fff; }

    .table-wrapper { overflow-x:auto; margin-bottom:1rem; width:100%; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.75rem; border:1px solid #ddd; text-align:left; }
    th { background: var(--amarillo-abeja); color: var(--blanco); }

    .pagination { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin-bottom:1rem; width:100%; }
    .pagination button {
      padding:.4rem .6rem; font-size:.9rem; background: var(--blanco); color: var(--negro);
      border:1px solid var(--verde-principal); border-radius:4px; cursor:pointer; transition:background .2s,color .2s;
    }
    .pagination button.current { background: var(--verde-principal); color: var(--blanco); cursor: default; }
    .pagination button.disabled { opacity:.5; cursor:default; }

    button.save-btn { background: var(--verde-principal); color: var(--blanco); border:none; border-radius:4px; padding:.4rem .8rem; cursor:pointer; }
    button.save-btn:hover { background: var(--verde-claro); }
    button.edit-btn { background: var(--amarillo-abeja); color: var(--blanco); border:none; border-radius:4px; padding:.4rem .8rem; cursor:pointer; }
    button.edit-btn:hover { background:#f0c94a; }
    button.delete-btn { background: var(--rojo); color: var(--blanco); border:none; border-radius:4px; padding:.4rem .8rem; cursor:pointer; }
    button.delete-btn:hover { background:#c9302c; }

    footer { background: var(--verde-principal); color: var(--blanco); text-align:center; padding:1rem; width:100%; }

    @media (max-width: 600px) {
      .tabs button { flex:1 1 100%; }
      .entity-form { grid-template-columns:1fr; }
      .entity-form button { grid-column:auto; }
      .filters, .code-search { flex-direction:column; }
      th, td { padding:.5rem; font-size:.85rem; }
      .pagination button { padding:.3rem .5rem; font-size:.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Objetos Perdidos</div>
    <div class="header-nav">
      <a href="../index.html">Inicio</a>
      <a href="/store/productos.html">Objetos</a>
      <button class="logout" id="logout-btn">Cerrar Sesión</button>
    </div>
  </header>

  <div class="tabs">
    <button data-tab="users" class="active">Usuarios</button>
    <button data-tab="objects-section">Objetos</button>
  </div>

  <main>
    <!-- USUARIOS -->
    <section id="users" class="active">
      <h2>Gestión de Usuarios</h2>

      <p id="users-warning" style="display:none; background:#fff3cd; color:#8a6d3b; border:1px solid #faebcc; padding:.6rem; border-radius:6px; margin:.5rem 0 1rem;">
        No tienes permisos para ver la lista de usuarios. Solo puedes editar tu propio perfil.
      </p>

      <div class="admin-tools">
        <button id="run-backfill" title="Sincroniza usuarios de Authentication a Firestore" style="display:none;">Sincronizar usuarios</button>
      </div>

      <form id="add-user-form" class="entity-form" autocomplete="off">
        <div>
          <label for="user-name">Nombre</label>
          <input type="text" id="user-name" required />
        </div>
        <div>
          <label for="user-role">Rol</label>
          <select id="user-role" required>
            <option value="user">Usuario</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div>
          <label for="user-email">Correo Electrónico</label>
          <input type="email" id="user-email" required />
        </div>
        <div>
          <label for="user-phone">Teléfono</label>
          <input type="tel" id="user-phone" required />
        </div>
        <div>
          <label for="user-password">Contraseña</label>
          <input type="password" id="user-password" />
        </div>
        <div>
          <label for="confirm-password">Confirmar Contraseña</label>
          <input type="password" id="confirm-password" />
        </div>

        <input type="hidden" id="editing-user-id" />
        <button type="submit" id="submit-user-btn">Agregar Usuario</button>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Nombre</th><th>Rol</th><th>Correo</th><th>Teléfono</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users-table-body"></tbody>
        </table>
      </div>
      <div id="users-pagination" class="pagination"></div>
    </section>

    <!-- OBJETOS -->
    <section id="objects-section">
      <h2>Gestión de Objetos</h2>

      <div class="filters">
        <input type="search" id="obj-search" placeholder="Buscar por código, nombre, descripción o lugar..." />
        <select id="obj-status-filter">
          <option value="all">Todos</option>
          <option value="por entregar">Por entregar</option>
          <option value="entregado">Entregado</option>
          <option value="de baja">De baja</option>
        </select>
      </div>

      <div class="code-search">
        <input type="text" id="obj-code-input" placeholder="Código exacto (p. ej. 7F2K9A1B)" />
        <button id="obj-code-btn" type="button" title="Buscar por código exacto">Buscar</button>
      </div>

      <p id="objects-warning" style="display:none;background:#fff3cd;color:#8a6d3b;border:1px solid #faebcc;padding:.6rem;border-radius:6px;margin:.5rem 0 1rem;">
        No tienes permisos para <strong>eliminar</strong> objetos. Puedes <strong>crear</strong> nuevos y <strong>cambiar el estado</strong> de los existentes.
      </p>

      <form id="add-object-form" class="entity-form" enctype="multipart/form-data" autocomplete="off">
        <div>
          <label for="object-name">Nombre del Objeto</label>
          <input type="text" id="object-name" required />
        </div>
        <div>
          <label for="object-date">Fecha de Recuperación</label>
          <input type="date" id="object-date" required />
        </div>
        <div>
          <label for="object-description">Descripción</label>
          <textarea id="object-description" rows="2" required></textarea>
        </div>
        <div>
          <label for="object-location">Lugar de Encuentro</label>
          <input type="text" id="object-location" required />
        </div>
        <div>
          <label for="object-image">Imagen del Objeto</label>
          <input type="file" id="object-image" accept="image/*" capture="environment" />
        </div>
        <button type="submit" id="submit-object-btn">Agregar Objeto</button>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Código</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Descripción</th>
              <th>Lugar</th>
              <th>Imagen</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="objects-table-body"></tbody>
        </table>
      </div>
      <div id="objects-pagination" class="pagination"></div>
    </section>
  </main>

  <footer>&copy; 2025 Infraestructura y Planta Física.</footer>

  <script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc,
      setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp,
      query, where, limit
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrh5AP2ErXaQAcZb0NMHq_5cBrvNZIlWo",
      authDomain: "objetosperdidos-76abd.firebaseapp.com",
      projectId: "objetosperdidos-76abd",
      storageBucket: "objetosperdidos-76abd.appspot.com",
      messagingSenderId: "609690831592",
      appId: "1:609690831592:web:f7a276b069c426ef53175d",
      measurementId: "G-95C30B5EK1"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence);
    const db   = getFirestore(app);

    // (Opcional) App secundaria si la usas para crear usuarios
    const secondaryApp  = initializeApp(firebaseConfig, 'secondary');
    const secondaryAuth = getAuth(secondaryApp);

    const functions = getFunctions(getApp());
    const backfillUsersToFirestore = httpsCallable(functions, 'backfillUsersToFirestore');

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const esc = (s = "") => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">", "&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    const enable = (el, yes=true) => { el.disabled = !yes; };

    function generarCodigo(len = 8) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i=0;i<len;i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
      return code;
    }
    async function existeCodigo(code) {
      const qy = query(collection(db,'objects'), where('code','==',code), limit(1));
      const snap = await getDocs(qy);
      return !snap.empty;
    }
    async function generarCodigoUnico(intentos = 8) {
      for (let i=0;i<intentos;i++){
        const c = generarCodigo(8);
        if(!(await existeCodigo(c))) return c;
      }
      return `X${Date.now().toString(36).toUpperCase()}`.slice(0,9);
    }

    $$('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tabs button').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        $$('main > section').forEach(s=>s.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    $('#logout-btn').addEventListener('click', async ()=>{
      await signOut(auth).catch(()=>{});
      window.location.href = '/store/admin.html';
    });

    let IS_ADMIN = false;

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = '/store/admin.html';

      try {
        const token = await user.getIdTokenResult();
        IS_ADMIN = !!token.claims?.admin;
      } catch (_) { IS_ADMIN = false; }

      if (!IS_ADMIN) {
        try {
          const meSnap = await getDoc(doc(db, 'users', user.uid));
          const myRole = meSnap.exists() ? (meSnap.data().role || 'user') : 'user';
          IS_ADMIN = (myRole === 'admin');
        } catch (_) { IS_ADMIN = false; }
      }

      const submitBtn = document.getElementById('submit-user-btn');
      const warning = document.getElementById('users-warning');
      const backfillBtn = document.getElementById('run-backfill');

      if (IS_ADMIN) {
        warning.style.display = 'none';
        if (backfillBtn) {
          backfillBtn.style.display = 'inline-block';
          backfillBtn.onclick = async ()=>{
            enable(backfillBtn, false); backfillBtn.textContent = 'Sincronizando...';
            try {
              const r = await backfillUsersToFirestore();
              alert(`Backfill finalizado. Creados: ${r.data?.created ?? 0}`);
              await loadUsers();
            } catch(e) {
              console.error(e);
              alert('Error ejecutando backfill. Verifica la Function y tu claim admin:true.');
            } finally {
              enable(backfillBtn, true); backfillBtn.textContent = 'Sincronizar usuarios';
            }
          };
        }
        loadUsers();
      } else {
        document.querySelector('#users .table-wrapper').style.display = 'none';
        document.getElementById('users-pagination').style.display = 'none';
        if (backfillBtn) backfillBtn.style.display = 'none';
        warning.style.display = 'block';
        submitBtn.textContent = 'Actualizar mi perfil';
        document.getElementById('user-role').disabled = true;
        document.getElementById('user-email').disabled = true;
        try {
          const meSnap = await getDoc(doc(db, 'users', user.uid));
          const d = meSnap.exists() ? meSnap.data() : {};
          document.getElementById('user-name').value  = d.name || user.displayName || '';
          document.getElementById('user-role').value  = d.role || 'user';
          document.getElementById('user-email').value = d.email || user.email || '';
          document.getElementById('user-phone').value = d.phone || '';
          document.getElementById('editing-user-id').value = user.uid;
        } catch (e) {
          console.error(e);
          alert('No fue posible cargar tu perfil.');
        }
      }

      // Mostrar aviso de permisos en Objetos si NO es admin
      const objWarn = document.getElementById('objects-warning');
      if (!IS_ADMIN && objWarn) objWarn.style.display = 'block';

      setupObjectsUI();
      loadObjects();
    });

    const ITEMS_PER_PAGE = 50;
    function paginate(items, page, renderFn, container, pager){
      const total = Math.max(1, Math.ceil(items.length/ITEMS_PER_PAGE));
      container.innerHTML = '';
      const start = (page-1)*ITEMS_PER_PAGE;
      items.slice(start, start+ITEMS_PER_PAGE).forEach((it,i)=>renderFn(it, start+i+1));
      pager.innerHTML = '';

      const mk = (lbl,p)=>{
        const b = document.createElement('button');
        b.textContent = lbl;
        if(p<1||p>total) b.classList.add('disabled');
        else if(p===page) b.classList.add('current');
        else b.onclick = ()=>paginate(items,p,renderFn,container,pager);
        pager.append(b);
      };
      mk('«',page-1);
      for(let i=1;i<=total;i++) mk(i,i);
      mk('»',page+1);
    }

    let users=[];
    const uBody  = document.getElementById('users-table-body');
    const uPager = document.getElementById('users-pagination');

    async function loadUsers(){
      users=[];
      const snap = await getDocs(collection(db,'users'));
      snap.forEach(d=>users.push({id:d.id, ...d.data()}));
      users.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
      paginate(users,1,renderUser,uBody,uPager);
    }

    function renderUser(u, idx){
      uBody.insertAdjacentHTML('beforeend', `
        <tr data-id="${esc(u.id)}">
          <td>${idx}</td>
          <td>${esc(u.name)}</td>
          <td>${esc(u.role)}</td>
          <td>${esc(u.email)}</td>
          <td>${esc(u.phone)}</td>
          <td>
            <button class="edit-btn">Editar</button>
            <button class="delete-btn">Eliminar</button>
          </td>
        </tr>
      `);
    }

    let objects=[]; let filtered=[];
    const oBody  = document.getElementById('objects-table-body');
    const oPager = document.getElementById('objects-pagination');
    const searchInput  = document.getElementById('obj-search');
    const statusFilter = document.getElementById('obj-status-filter');

    const codeInput = document.getElementById('obj-code-input');
    const codeBtn   = document.getElementById('obj-code-btn');

    function setupObjectsUI(){
      if (searchInput) searchInput.addEventListener('input', applyObjectFilters);
      if (statusFilter) statusFilter.addEventListener('change', applyObjectFilters);

      const d=new Date();
      const today=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const dateInput=document.getElementById('object-date');
      if(dateInput && !dateInput.value) dateInput.value = today;

      if (codeBtn) {
        codeBtn.addEventListener('click', async ()=>{
          const raw = (codeInput?.value || '').trim();
          if (!raw) { applyObjectFilters(); return; }
          const code = raw.toUpperCase();

          let match = objects.find(o => (o.code||'').toUpperCase() === code);
          if (!match) {
            try {
              const qy = query(collection(db,'objects'), where('code','==', code), limit(1));
              const snap = await getDocs(qy);
              if (!snap.empty) {
                const d = snap.docs[0];
                match = { id: d.id, ...d.data() };
              }
            } catch (_) {}
          }

          if (match) {
            paginate([match], 1, renderObject, oBody, oPager);
          } else {
            oBody.innerHTML = `
              <tr><td colspan="9" style="text-align:center;color:#666;">
                No se encontró un objeto con el código <strong>${esc(code)}</strong>.
              </td></tr>`;
            oPager.innerHTML = '';
          }
        });
      }
    }

    async function loadObjects(){
      objects=[];
      const snap = await getDocs(collection(db,'objects'));
      for (const d of snap.docs) {
        const data = d.data();
        // Solo los admin pueden "sanear" y asignar code faltante
        if (!data.code && IS_ADMIN) {
          try {
            const nuevo = await generarCodigoUnico();
            await updateDoc(doc(db,'objects', d.id), { code: nuevo });
            data.code = nuevo;
          } catch (e) {
            console.warn('No se pudo asignar code a', d.id, e?.message||e);
          }
        }
        objects.push({ id: d.id, ...data });
      }
      objects.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
      applyObjectFilters();
    }

    function applyObjectFilters(){
      const q = (searchInput?.value || '').trim().toLowerCase();
      const st = statusFilter?.value || 'all';

      let base = objects.slice();
      if (st !== 'all') base = base.filter(o => (o.status || 'por entregar') === st);
      if (q) {
        base = base.filter(o => {
          const haystack = `${o.code||''} ${o.name||''} ${o.description||''} ${o.location||''}`.toLowerCase();
          return haystack.includes(q);
        });
      }
      filtered = base;
      paginate(filtered, 1, renderObject, oBody, oPager);
    }

    function renderObject(o, idx){
      oBody.insertAdjacentHTML('beforeend', `
        <tr data-id="${esc(o.id)}">
          <td>${idx}</td>
          <td>${esc(o.code || '')}</td>
          <td>${esc(o.name || '')}</td>
          <td>${esc(o.date || '')}</td>
          <td>${esc(o.description || '')}</td>
          <td>${esc(o.location || '')}</td>
          <td>${o.imageUrl ? `<img src="${esc(o.imageUrl)}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">` : '—'}</td>
          <td>
            <select class="status-select">
              <option value="por entregar"${(o.status||'por entregar')==='por entregar'?' selected':''}>Por entregar</option>
              <option value="entregado"${o.status==='entregado'?' selected':''}>Entregado</option>
              <option value="de baja"${o.status==='de baja'?' selected':''}>De baja</option>
            </select>
          </td>
          <td>
            <button class="save-btn">Guardar</button>
            ${IS_ADMIN ? '<button class="delete-btn">Eliminar</button>' : ''}
          </td>
        </tr>
      `);
    }

    // Guardar estado (todos los roles)
    oBody.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button'); if (!btn) return;
      const row = btn.closest('tr'); const id = row?.dataset?.id; if (!id) return;

      if (btn.classList.contains('save-btn')) {
        try {
          const status = row.querySelector('.status-select').value;
          await updateDoc(doc(db,'objects',id), { status });
          alert('Estado actualizado.');
        } catch(e) { console.error(e); alert('Error actualizando estado.'); }
      }

      if (btn.classList.contains('delete-btn')) {
        if(!confirm('¿Eliminar este objeto?')) return;
        try { await deleteDoc(doc(db,'objects',id)); await loadObjects(); }
        catch(e) { console.error(e); alert('Error eliminando objeto.'); }
      }
    });

    // Crear objeto (users y admin): incluye createdBy/createdAt
    document.getElementById('add-object-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const submitBtn = document.getElementById('submit-object-btn'); enable(submitBtn, false);

      const f = e.target;
      const name = f['object-name'].value.trim();
      const date = f['object-date'].value;
      const desc = f['object-description'].value.trim();
      const loc  = f['object-location'].value.trim();
      const file = f['object-image'].files[0];

      if(!name||!date||!desc||!loc){
        alert('Todos los campos excepto imagen son obligatorios.');
        return enable(submitBtn, true);
      }

      try {
        let imageUrl = '';
        if(file){
          const fd = new FormData();
          fd.append('file', file);
          fd.append('upload_preset', 'ObjetosPerdidos');
          const res = await fetch('https://api.cloudinary.com/v1_1/dplgx0sze/upload', { method:'POST', body: fd });
          const js  = await res.json();
          imageUrl  = js.secure_url || '';
        }

        const code = await generarCodigoUnico();

        await addDoc(collection(db,'objects'),{
          code,
          name,
          date,
          description: desc,
          location: loc,
          imageUrl,
          status: 'por entregar',
          createdAt: serverTimestamp(),
          createdBy: auth.currentUser.uid
        });

        alert(`Objeto agregado. Código: ${code}`);
        f.reset();
        await loadObjects();
      } catch (err) {
        console.error(err);
        alert('Error agregando el objeto.');
      } finally {
        enable(submitBtn, true);
      }
    });

  </script>
</body>
</html>
