<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Usuarios y Objetos Perdidos</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --verde-principal: #2e9d57;
      --verde-claro:    #7dd081;
      --amarillo-abeja: #f9d94e;
      --rojo:           #d9534f;
      --negro:          #1a1a1a;
      --blanco:         #fefefe;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: var(--negro);
    }
    header {
      background: var(--verde-principal);
      color: var(--blanco);
      padding: 1rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .main-title { font-size: 1.8rem; }
    .logout-button {
      background: var(--rojo);
      color: var(--blanco);
      border: none; padding: .5rem 1rem; border-radius: 5px;
      cursor: pointer;
    }
    .logout-button:hover { background: #c9302c; }
    .tabs {
      display: flex; justify-content: center; gap: .5rem;
      margin: 1.5rem 0;
    }
    .tabs button {
      flex: 1 1 150px; padding: 1rem;
      background: var(--amarillo-abeja); color: var(--blanco);
      border: none; border-radius: 5px;
      font-weight: bold; cursor: pointer;
      transition: background .3s;
    }
    .tabs button.active { background: var(--verde-claro); }
    main {
      max-width: 960px; margin: 0 auto 2rem; padding: 0 1rem;
    }
    section { display: none; }
    section.active { display: block; }

    /* Formularios */
    .entity-form {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
      background: var(--blanco); padding: 1rem; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1rem;
    }
    .entity-form label { font-weight: bold; }
    .entity-form input, .entity-form select, .entity-form textarea {
      width: 100%; padding: .5rem; border: 1px solid #ccc; border-radius: 4px;
    }
    .entity-form button {
      grid-column: span 2; padding: .75rem;
      background: var(--amarillo-abeja); color: var(--blanco);
      border: none; border-radius: 5px;
      font-weight: bold; cursor: pointer;
      transition: background .3s;
    }
    .entity-form button:hover { background: var(--verde-claro); }

    /* Tablas */
    .table-wrapper { overflow-x: auto; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td {
      padding: .75rem; border: 1px solid #ddd; text-align: left;
    }
    th {
      background: var(--amarillo-abeja); color: var(--blanco);
    }
    button.save-btn, button.edit-btn, button.delete-btn {
      padding: .4rem .8rem; border: none; border-radius: 4px;
      cursor: pointer; margin-right: .25rem;
    }
    button.save-btn { background: var(--verde-principal); color: var(--blanco); }
    button.save-btn:hover { background: var(--verde-claro); }
    button.edit-btn { background: var(--amarillo-abeja); color: var(--blanco); }
    button.edit-btn:hover { background: #f0c94a; }
    button.delete-btn { background: var(--rojo); color: var(--blanco); }
    button.delete-btn:hover { background: #c9302c; }

    /* Paginación */
    .pagination {
      display: flex; justify-content: center; gap: .5rem; margin-bottom: 2rem;
    }
    .pagination button {
      background: var(--blanco); color: var(--negro);
      border: 1px solid var(--verde-principal);
      padding: .4rem .8rem; border-radius: 4px;
      cursor: pointer; transition: background .2s, color .2s;
    }
    .pagination button.current {
      background: var(--verde-principal); color: var(--blanco);
      cursor: default;
    }
    .pagination button.disabled {
      opacity: .5; cursor: default;
    }
  </style>
</head>
<body>
  <header>
    <div class="main-title">GESTIÓN DE USUARIOS Y OBJETOS</div>
    <button id="logout-button" class="logout-button">Cerrar Sesión</button>
  </header>

  <div class="tabs">
    <button data-tab="user" class="active">Usuarios</button>
    <button data-tab="object">Objetos</button>
  </div>

  <main>
    <!-- SECCIÓN USUARIOS -->
    <section id="user-tab" class="active">
      <h2>Usuarios</h2>
      <form id="add-user-form" class="entity-form">
        <div><label for="user-name">Nombre</label><input type="text" id="user-name" required /></div>
        <div><label for="user-role">Rol</label>
          <select id="user-role" required>
            <option value="user">Usuario</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div><label for="user-email">Correo Electrónico</label><input type="email" id="user-email" required /></div>
        <div><label for="user-phone">Teléfono</label><input type="tel" id="user-phone" required /></div>
        <div><label for="user-password">Contraseña</label><input type="password" id="user-password" required /></div>
        <div><label for="confirm-password">Confirmar Contraseña</label><input type="password" id="confirm-password" required /></div>
        <input type="hidden" id="editing-user-id" />
        <button type="submit" id="submit-user-btn">Agregar Usuario</button>
      </form>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>#</th><th>Nombre</th><th>Rol</th><th>Correo</th><th>Teléfono</th><th>Acciones</th></tr>
          </thead>
          <tbody id="users-table-body"></tbody>
        </table>
      </div>
      <div id="users-pagination" class="pagination"></div>
    </section>

    <!-- SECCIÓN OBJETOS -->
    <section id="object-tab">
      <h2>Objetos</h2>
      <form id="add-object-form" class="entity-form" enctype="multipart/form-data">
        <div><label for="object-name">Nombre del Objeto</label><input type="text" id="object-name" required /></div>
        <div><label for="object-date">Fecha de Recuperación</label><input type="date" id="object-date" required /></div>
        <div><label for="object-description">Descripción</label><textarea id="object-description" rows="2" required></textarea></div>
        <div><label for="object-location">Lugar de Encuentro</label><input type="text" id="object-location" required /></div>
        <div>
          <label for="object-image">Imagen del Objeto</label>
          <input type="file" id="object-image" accept="image/*" capture="environment" />
        </div>
        <button type="submit">Agregar Objeto</button>
      </form>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Nombre</th><th>Fecha</th><th>Descripción</th><th>Lugar</th>
              <th>Imagen</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="objects-table-body"></tbody>
        </table>
      </div>
      <div id="objects-pagination" class="pagination"></div>
    </section>
  </main>

  <footer><p>&copy; 2025 Objetos Perdidos</p></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // Inicialización Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBrh5AP2ErXaQAcZb0NMHq_5cBrvNZIlWo",
      authDomain: "objetosperdidos-76abd.firebaseapp.com",
      projectId: "objetosperdidos-76abd",
      storageBucket: "objetosperdidos-76abd.appspot.com",
      messagingSenderId: "609690831592",
      appId: "1:609690831592:web:f7a276b069c426ef53175d",
      measurementId: "G-95C30B5EK1"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence);
    const db   = getFirestore(app);

    // Paginación auxiliar
    const ITEMS_PER_PAGE = 50;
    function paginate(items, page, fn, container, pager) {
      const total = Math.ceil(items.length / ITEMS_PER_PAGE);
      container.innerHTML = "";
      const start = (page - 1) * ITEMS_PER_PAGE;
      items.slice(start, start + ITEMS_PER_PAGE).forEach((it, i) => fn(it, start + i + 1));
      pager.innerHTML = "";
      const makeBtn = (label, p) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        if (p < 1 || p > total) btn.classList.add("disabled");
        else if (p === page) btn.classList.add("current");
        else btn.onclick = () => paginate(items, p, fn, container, pager);
        pager.append(btn);
      };
      makeBtn("«", page - 1);
      for (let i = 1; i <= total; i++) makeBtn(i, i);
      makeBtn("»", page + 1);
    }

    // USUARIOS
    let users = [];
    const usersBody = document.getElementById("users-table-body");
    const usersPager = document.getElementById("users-pagination");

    async function loadUsers() {
      users = [];
      (await getDocs(collection(db, "users"))).forEach(d => users.push({ id: d.id, ...d.data() }));
      users.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
      paginate(users, 1, renderUser, usersBody, usersPager);
    }

    function renderUser(u, idx) {
      usersBody.insertAdjacentHTML("beforeend", `
        <tr data-id="${u.id}">
          <td>${idx}</td>
          <td>${u.name}</td>
          <td>${u.role}</td>
          <td>${u.email}</td>
          <td>${u.phone}</td>
          <td>
            <button class="edit-btn">Editar</button>
            <button class="delete-btn">Eliminar</button>
          </td>
        </tr>`);
      attachUserListeners();
    }

    function attachUserListeners() {
      usersBody.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = async () => {
          const id = btn.closest("tr").dataset.id;
          const data = (await getDoc(doc(db, "users", id))).data();
          document.getElementById("user-name").value = data.name;
          document.getElementById("user-role").value = data.role;
          document.getElementById("user-email").value = data.email;
          document.getElementById("user-phone").value = data.phone;
          document.getElementById("user-password").value = '';
          document.getElementById("confirm-password").value = '';
          document.getElementById("editing-user-id").value = id;
          document.getElementById("submit-user-btn").textContent = "Actualizar Usuario";
        };
      });
      usersBody.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("¿Estás seguro que quieres eliminar este usuario?")) return;
          const id = btn.closest("tr").dataset.id;
          try {
            await deleteDoc(doc(db, "users", id));
            loadUsers();
          } catch (err) {
            alert("Error al eliminar usuario: " + err.code);
          }
        };
      });
    }

    document.getElementById("add-user-form").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("editing-user-id").value;
      const name = document.getElementById("user-name").value.trim();
      const role = document.getElementById("user-role").value;
      const email = document.getElementById("user-email").value.trim();
      const phone = document.getElementById("user-phone").value.trim();
      const pwd = document.getElementById("user-password").value;
      const pwd2 = document.getElementById("confirm-password").value;
      if (!name || !role || !email || !phone || !pwd || !pwd2) {
        return alert("Todos los campos son obligatorios.");
      }
      if (pwd !== pwd2) {
        return alert("Las contraseñas no coinciden.");
      }
      if (id) {
        try {
          await updateDoc(doc(db, "users", id), { name, role, email, phone });
          alert("Usuario actualizado.");
        } catch (err) {
          alert("Sin permisos: " + err.code);
        }
      } else {
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pwd);
          await setDoc(doc(db, "users", cred.user.uid), {
            uid: cred.user.uid,
            name,
            role,
            email,
            phone,
            createdAt: serverTimestamp()
          });
          alert("Usuario creado.");
        } catch (err) {
          alert("Error creando usuario: " + err.code);
        }
      }
      e.target.reset();
      document.getElementById("editing-user-id").value = "";
      document.getElementById("submit-user-btn").textContent = "Agregar Usuario";
      loadUsers();
    });

    // SECCIÓN OBJETOS
    let objects = [];
    const objBody = document.getElementById("objects-table-body");
    const objPager = document.getElementById("objects-pagination");

    async function loadObjects() {
      objects = [];
      (await getDocs(collection(db, "objects"))).forEach(d => objects.push({ id: d.id, ...d.data() }));
      objects.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
      paginate(objects, 1, renderObject, objBody, objPager);
    }

    function renderObject(o, idx) {
      objBody.insertAdjacentHTML("beforeend", `
        <tr data-id="${o.id}">
          <td>${idx}</td><td>${o.name}</td><td>${o.date}</td>
          <td>${o.description}</td><td>${o.location}</td>
          <td>${o.imageUrl ? `<img src="${o.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">` : '—' }</td>
          <td>
            <select class="status-select">
              <option value="por entregar"${o.status === 'por entregar' ? ' selected' : ''}>Por entregar</option>
              <option value="entregado"${o.status === 'entregado' ? ' selected' : ''}>Entregado</option>
              <option value="de baja"${o.status === 'de baja' ? ' selected' : ''}>De baja</option>
            </select>
          </td>
          <td>
            <button class="save-btn">Guardar</button>
            <button class="delete-btn">Eliminar</button>
          </td>
        </tr>`);
      attachObjectListeners();
    }

    function attachObjectListeners() {
      objBody.querySelectorAll(".save-btn").forEach(btn => {
        btn.onclick = async () => {
          const row = btn.closest("tr");
          const id = row.dataset.id;
          const status = row.querySelector(".status-select").value;
          try {
            await updateDoc(doc(db, "objects", id), { status });
            if (status !== 'por entregar') row.remove();
            alert("Estado actualizado.");
          } catch (err) {
            alert("Sin permisos: " + err.code);
          }
        };
      });
      objBody.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("¿Estás seguro que quieres eliminar este objeto?")) return;
          const id = btn.closest("tr").dataset.id;
          try {
            await deleteDoc(doc(db, "objects", id));
            loadObjects();
          } catch (err) {
            alert("Sin permisos: " + err.code);
          }
        };
      });
    }

    document.getElementById("add-object-form").addEventListener("submit", async e => {
      e.preventDefault();
      const f = e.target;
      const name = f["object-name"].value.trim();
      const date = f["object-date"].value;
      const desc = f["object-description"].value.trim();
      const loc = f["object-location"].value.trim();
      const file = f["object-image"].files[0];
      if (!name || !date || !desc || !loc) return alert("Todos los campos excepto imagen son obligatorios.");
      let imageUrl = "";
      if (file) {
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", "ObjetosPerdidos");
        const res = await fetch(`https://api.cloudinary.com/v1_1/dplgx0sze/upload`, { method: "POST", body: fd });
        const js = await res.json();
        imageUrl = js.secure_url;
      }
      try {
        await addDoc(collection(db, "objects"), {
          name, date, description: desc, location: loc,
          imageUrl, status: "por entregar", createdAt: serverTimestamp()
        });
        alert("Objeto agregado.");
        f.reset();
        loadObjects();
      } catch (err) {
        alert("Error agregando objeto: " + err.code);
      }
    });

    // Tabs y Logout
    document.querySelectorAll(".tabs button").forEach(btn => btn.onclick = () => {
      document.querySelectorAll(".tabs button").forEach(x => x.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(`${btn.dataset.tab}-tab`).classList.add("active");
    });
    document.getElementById("logout-button").onclick = async () => {
      await signOut(auth);
      location.href = "../store/admin.html";
    };

    // Auth guard
    onAuthStateChanged(auth, user => {
      if (!user) return location.href = "../store/admin.html";
      loadUsers();
      loadObjects();
    });
  </script>
</body>
</html>
