<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#2e9d57" />
  <link rel="icon" href="/img/favicon.png" type="image/x-icon" />
  <title>Objetos Perdidos</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --verde-principal:#2e9d57;
      --verde-claro:#7dd081;
      --amarillo-abeja:#f9d94e;
      --azul-oscuro:#2b4f97;
      --negro:#1a1a1a;
      --blanco:#fff;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: Arial, sans-serif;
      color: var(--negro);
      background: url("../img/background.png") no-repeat center center fixed;
      background-size: cover;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Header */
    header{
      background:var(--verde-principal);
      color:var(--blanco);
      padding:1rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1{font-size:2rem}
    header nav{display:flex; gap:1rem; align-items:center}
    header nav a{color:#fff; text-decoration:none; font-weight:700}
    header nav a:hover{color:var(--amarillo-abeja)}

    main{width:100%; max-width:1200px; margin:0 auto; padding:1.25rem 1rem; flex:1}

    /* Search bar */
    .search-row{
      display:flex; gap:.6rem; align-items:center; margin: .75rem 0 1.2rem;
      flex-wrap:wrap; justify-content:center;
    }
    .search-row input[type="text"]{
      flex:1 1 680px;
      max-width:960px;
      padding:.75rem .9rem;
      border:1px solid #ccc;
      border-radius:8px;
      background:rgba(255,255,255,.95);
      outline:none;
    }
    .btn{
      padding:.7rem 1rem; border-radius:8px; border:1px solid transparent; cursor:pointer;
      font-weight:700;
    }
    .btn-primary{background:var(--verde-principal); color:#fff}
    .btn-primary:hover{background:#25874a}
    .btn-light{background:#fff; color:#333; border-color:#ddd}
    .btn-light:hover{background:#f3f3f3}

    h2{
      color:var(--azul-oscuro);
      text-align:center;
      margin:.6rem 0 1rem;
    }

    /* Lista tarjetas con estilos anteriores */
    #productos-lista{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(260px,1fr));
      gap:1rem;
    }
    .card{
      display:flex;
      flex-direction:column;
      background:#fff;
      border-radius:8px;
      border:1px solid #ddd;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      overflow:hidden;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .card-img{
      width:100%;
      height:180px;
      object-fit:cover;
      border-bottom:1px solid #ddd;
      background:#f6f6f6;
    }
    .card-body{padding:0.9rem}
    .card-title{
      font-size:1.1rem; margin:0 0 .5rem; font-weight:700; color:#333;
    }
    .card-meta{
      margin:.25rem 0; font-size:.92rem; color:#555;
    }
    .reclamar{
      margin:.9rem; padding:.5rem .8rem;
      background-color:#ffc107; color:#000; border:none; border-radius:6px;
      cursor:pointer; font-weight:700; transition:background-color .2s ease;
      align-self:flex-start;
    }
    .reclamar:hover{background-color:#e0a800}

    /* Paginación */
    .pagination{
      display:flex; flex-wrap:wrap; gap:.35rem; justify-content:center; margin:1.1rem 0;
    }
    .pagination button{
      min-width:38px; padding:.45rem .65rem; border:1px solid var(--verde-principal);
      background:#fff; color:#000; border-radius:6px; cursor:pointer; font-weight:700;
    }
    .pagination button:hover{background:var(--verde-principal); color:#fff}
    .pagination .current{background:var(--verde-principal); color:#fff; cursor:default}
    .pagination .disabled{opacity:.5; cursor:default}

    footer{
      text-align:center; padding:1rem; background:var(--verde-principal); color:#fff;
      margin-top:auto;
    }

    .center{display:flex; justify-content:center; align-items:center}
    .muted{color:#666}
  </style>
</head>
<body>
  <header>
    <h1>Objetos Perdidos</h1>
    <nav>
      <a href="../index.html">Inicio</a>
      <a href="admin.html" title="Iniciar Sesión">
        <i class="fa-solid fa-right-to-bracket fa-lg"></i>
      </a>
    </nav>
  </header>

  <main>
    <!-- Buscador -->
    <div class="search-row">
      <input id="q" type="text" placeholder="Buscar por palabra (nombre, descripción o lugar)…" maxlength="80" aria-label="Buscar objetos"/>
      <button id="btn-search" class="btn btn-primary" type="button">Buscar</button>
      <button id="btn-clear" class="btn btn-light" type="button">Limpiar</button>
    </div>

    <h2>Últimos Objetos Registrados</h2>

    <!-- Lista -->
    <div id="productos-lista" aria-live="polite">
      <p class="center muted" style="grid-column:1/-1">Cargando objetos…</p>
    </div>

    <!-- Paginación -->
    <div id="pagination" class="pagination" aria-label="Paginación"></div>
  </main>

  <footer>&copy; 2025 Infraestructura y Planta Física.</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    /* ---------- Config Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrh5AP2ErXaQAcZb0NMHq_5cBrvNZIlWo",
      authDomain: "objetosperdidos-76abd.firebaseapp.com",
      projectId: "objetosperdidos-76abd",
      storageBucket: "objetosperdidos-76abd.appspot.com",
      messagingSenderId: "609690831592",
      appId: "1:609690831592:web:f7a276b069c426ef53175d",
      measurementId: "G-95C30B5EK1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------- Utilidades ---------- */
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const esc = (v="") => String(v)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const formatDate = ts => {
      try{
        const d = ts?.toDate?.() ?? null;
        return d ? d.toLocaleString("es-CO",{dateStyle:"medium", timeStyle:"short"}) : "";
      }catch{ return ""; }
    };

    /* ---------- Estado ---------- */
    const ITEMS_PER_PAGE = 20;
    let allObjects = [];       // todos los "por entregar"
    let filtered = [];         // filtro actual
    let currentPage = 1;

    const listEl = $("#productos-lista");
    const pagerEl = $("#pagination");
    const inputQ = $("#q");
    const btnSearch = $("#btn-search");
    const btnClear = $("#btn-clear");

    /* ---------- Carga de datos ---------- */
    async function fetchObjects(){
      listEl.innerHTML = `<p class="center muted" style="grid-column:1/-1">Cargando objetos…</p>`;
      try{
        const snap = await getDocs(collection(db,"objects"));
        const tmp = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          if ((d?.status||"").toLowerCase() === "por entregar"){
            tmp.push({
              id: docSnap.id,
              name: d?.name || "",
              description: d?.description || "",
              location: d?.location || "",
              imageUrl: d?.imageUrl || "",
              createdAt: d?.createdAt || null
            });
          }
        });
        // ordenar por fecha desc.
        tmp.sort((a,b)=>{
          const ta = a.createdAt?.toMillis?.() ?? 0;
          const tb = b.createdAt?.toMillis?.() ?? 0;
          return tb - ta;
        });

        allObjects = tmp;
        applyFilter(); // render inicial
      }catch(err){
        console.error(err);
        listEl.innerHTML = "";
        const box = document.createElement("div");
        box.className = "center";
        box.style.gridColumn = "1 / -1";
        box.innerHTML = `<span class="muted">No fue posible cargar los objetos.</span>`;
        const retry = document.createElement("button");
        retry.type = "button";
        retry.className = "btn btn-light";
        retry.style.marginLeft = ".5rem";
        retry.textContent = "Reintentar";
        retry.addEventListener("click", fetchObjects);
        box.appendChild(retry);
        listEl.appendChild(box);
      }
    }

    /* ---------- Filtro ---------- */
    function applyFilter(){
      const q = inputQ.value.trim().toLowerCase();
      filtered = !q ? allObjects : allObjects.filter(o=>{
        const hay = [o.name, o.description, o.location]
          .map(x=>String(x||"").toLowerCase())
          .some(text => text.includes(q));
        return hay;
      });
      currentPage = 1;
      render();
    }

    /* ---------- Render ---------- */
    function render(){
      renderCards();
      renderPagination();
    }

    function renderCards(){
      listEl.innerHTML = "";
      if (!filtered.length){
        const p = document.createElement("p");
        p.className = "center muted";
        p.style.gridColumn = "1 / -1";
        p.textContent = "No hay objetos para mostrar.";
        listEl.appendChild(p);
        return;
      }
      const start = (currentPage-1)*ITEMS_PER_PAGE;
      const slice = filtered.slice(start, start+ITEMS_PER_PAGE);

      for(const o of slice){
        const card = document.createElement("article");
        card.className = "card";

        const img = document.createElement("img");
        img.className = "card-img";
        img.alt = esc(o.name || "Objeto");
        img.loading = "lazy";
        img.src = o.imageUrl || "https://via.placeholder.com/400x250?text=Sin+Imagen";
        card.appendChild(img);

        const body = document.createElement("div");
        body.className = "card-body";

        const h3 = document.createElement("h3");
        h3.className = "card-title";
        h3.textContent = o.name || "Objeto";
        body.appendChild(h3);

        const p1 = document.createElement("p");
        p1.className = "card-meta";
        p1.innerHTML = `<strong>Fecha registro:</strong> ${esc(formatDate(o.createdAt))}`;
        body.appendChild(p1);

        const p2 = document.createElement("p");
        p2.className = "card-meta";
        p2.innerHTML = `<strong>Descripción:</strong> ${esc(o.description)}`;
        body.appendChild(p2);

        const p3 = document.createElement("p");
        p3.className = "card-meta";
        p3.innerHTML = `<strong>Lugar:</strong> ${esc(o.location)}`;
        body.appendChild(p3);

        card.appendChild(body);

        const btn = document.createElement("button");
        btn.className = "reclamar";
        btn.type = "button";
        btn.textContent = "Reclamar";
        btn.addEventListener("click", ()=>{
          const nameEnc = encodeURIComponent(o.name || "");
          location.href = `carrito.html?id=${o.id}&name=${nameEnc}`;
        });
        card.appendChild(btn);

        listEl.appendChild(card);
      }
    }

    function renderPagination(){
      pagerEl.innerHTML = "";
      const total = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
      const mk = (label, page, {disabled=false, current=false}={})=>{
        const b = document.createElement("button");
        b.textContent = label;
        if (disabled){ b.classList.add("disabled"); b.disabled = true; }
        else if (current){ b.classList.add("current"); b.disabled = true; }
        else { b.addEventListener("click", ()=>{ currentPage = page; render(); }); }
        pagerEl.appendChild(b);
      };
      mk("«", currentPage-1, {disabled: currentPage<=1});
      for (let i=1;i<=total;i++){
        mk(String(i), i, {current: i===currentPage});
      }
      mk("»", currentPage+1, {disabled: currentPage>=total});
    }

    /* ---------- Eventos ---------- */
    btnSearch.addEventListener("click", applyFilter);
    btnClear.addEventListener("click", ()=>{
      inputQ.value = "";
      applyFilter();
      inputQ.focus();
    });
    inputQ.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){ e.preventDefault(); applyFilter(); }
    });

    /* ---------- Init ---------- */
    fetchObjects();
  </script>
</body>
</html>
